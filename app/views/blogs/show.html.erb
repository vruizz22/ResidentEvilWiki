<section class="section">
  <div class="container">
    <div class="has-text-centered">
      <h1 class="title is-3 mb-5"><%= @blog.titulo %></h1>
      <!-- Mostrar adjunto -->
      <% if @blog.attachment.attached? %>
        <div class="content mb-5">
          <% if @blog.attachment.image? %>
            <%= cl_image_tag(
                  @blog.attachment.key,
                  width: 800,
                  height: 600,
                  crop: :limit,
                  quality: :auto,
                  secure: true,
                  class: "blog-image",
                  loading: "lazy",
                  alt: "Imagen adjunta del blog"
                ) %>
          <% end %>
        </div>
      <% end %>
      <!-- Fin de la secci√≥n de adjuntos optimizados -->
      <div class="content mb-5" style="word-break: break-word; overflow-wrap: break-word; max-width: 100%; white-space: pre-line; text-align: justify;">
        <p><%= @blog.descripcion %></p>
        <p><strong>Tipo de publicaci√≥n:</strong> <%= @blog.tipo_publicacion.capitalize %></p>
        <% if @blog.etiquetas.present? %>
          <p><strong>Etiquetas:</strong> <%= @blog.etiquetas %></p>
        <% end %>
        <p class="has-text-grey-light is-size-7">
          Publicado el <%= @blog.created_at.strftime("%d/%m/%Y") %> por <%= @blog.autor&.nombre || "Autor desconocido" %>
        </p>
      </div>
    </div>

    <% if @blog.estado == "rechazado" && @blog.mensaje_moderacion.present? && user_signed_in? && @blog.autor == current_user %>
      <div class="notification is-danger mt-4">
        <strong>Tu blog fue rechazado por un moderador.</strong><br>
        Motivo: <%= @blog.mensaje_moderacion %>
      </div>
    <% elsif @blog.estado == "aprobado" && user_signed_in? && @blog.autor == current_user %>
      <div class="notification is-success mt-4">
        ‚úÖ‚òÇ¬°Tu blog fue aceptado por un moderador!‚òÇ‚úÖ
      </div>
    <% end %>

    <div class="buttons mt-4">
      <%= link_to 'Volver a la lista de blogs', blogs_path, class: 'button is-light' %>
    </div>

    <% if user_signed_in? %>
      <div class="buttons mt-4 is-justify-content-center">
        <% if @blog.autor == current_user %>
          <%= link_to "Solicitar edici√≥n", new_solicitud_edicion_path(blog_id: @blog.id), class: "button is-warning" %>
        <% end %>
        <%= link_to "Ir al chat", blog_chat_room_path(@blog), class: "button is-info" %>
      </div>
    <% end %>


    <!-- Secci√≥n de Rese√±as -->
    <div class="box mt-6 mb-6">
      <h2 class="title is-4 mb-4">Rese√±as</h2>
      <p class="mb-5">
        <strong><%= @reviews.count %></strong> rese√±a(s) &nbsp;|&nbsp;
        Promedio: 
        <strong>
          <%= @reviews.any? ? sprintf('%.2f', @reviews.average(:calificacion)) : 'N/A' %>
        </strong> ‚≠ê
      </p>
    
      <!-- Formulario para nueva rese√±a -->
      <% if user_signed_in? %>
        <div class="mb-5">
          <%= form_with(model: @review, url: reviews_path, local: true) do |f| %>
            <%= f.hidden_field :id_blog, value: @blog.id %>
            <div class="field mb-4">
              <label class="label">Calificaci√≥n</label>
              <div class="control">
                <%= f.number_field :calificacion, in: 1..5, step: 1, class: "input", placeholder: "1-5" %>
              </div>
            </div>
            <div class="field mb-4">
              <label class="label">Comentario</label>
              <div class="control">
                <%= f.text_area :descripcion, class: "textarea", placeholder: "Escribe tu rese√±a aqu√≠..."%>
              </div>
            </div>
            <div class="field">
              <div class="control">
                <%= f.submit "Publicar rese√±a", class: "button is-primary" %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="has-text-grey mb-5">Inicia sesi√≥n para dejar una rese√±a.</p>
      <% end %>
    
      <hr class="mb-5">
    
      <!-- Listado de rese√±as -->
      <% @reviews.each do |review| %>
        <div class="box mb-5" style="position: relative;">
          <p>
            <strong><%= review.user&.nombre || "Usuario" %></strong>
            <span class="tag is-warning is-light"> <%= review.calificacion %> ‚≠ê</span>
            <span class="is-size-7 has-text-grey-light"> <%= review.created_at.strftime("%d/%m/%Y %H:%M") %></span>
            <% if user_signed_in? && current_user.admin? %>
              <%= button_to "üóëÔ∏è", review_path(review), method: :delete,
                    class: "button is-danger is-small",
                    style: "position: absolute; top: 0; right: 0;",
                    form: { onsubmit: "return confirm('¬øSeguro que deseas borrar esta rese√±a?')" } %>
            <% end %>
          </p>
          <p class="mt-3"
             style="word-break: break-word; overflow-wrap: break-word; max-width: 100%; white-space: pre-line;">
            <%= review.descripcion %>
          </p>
        </div>
      <% end %>
    <!-- Fin de la secci√≥n de Rese√±as -->

  </div>
</section>
